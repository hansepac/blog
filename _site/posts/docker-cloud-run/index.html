<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Hans Capener">
<meta name="dcterms.date" content="2024-10-10">

<title>Cloud Run Docker with OAuth – Capener Consulting LLC</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Capener Consulting LLC</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/hans-capener-72a76a291/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/hansepac"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Cloud Run Docker with OAuth</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Google Cloud Project</div>
                <div class="quarto-category">Hosting</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Hans Capener </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 10, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>A guide to publishing a streamlit application in Google Cloud using a Docker container. This guide will also include steps to setup an OAuth security layer using GCP’s Identity-Aware Proxy, so only individuals with a certain google email domain can access it. It should be noted that these steps will work to publish any docker container, but this guide will showcase streamlit in particular.</p>
<p>Prerequisites:</p>
<ul>
<li>A Google account with access to the Google Cloud Console.</li>
<li>A Google Cloud Project with access to a billing account.</li>
<li>A functioning dockerized streamlit application (or other application) being run on port 8080. This is Cloud Run’s default port. You may use a different port if you to change settings in Google Cloud during the Cloud Run deployment process.</li>
<li>(For OAuth with Identiy-Aware Proxy) Ownership of a domain. (example.com)</li>
</ul>
<p>Throughout this tutorial, Google Cloud will state its need for certain services to be enabled. Enable them as they come.</p>
</section>
<section id="hosting-docker-containers-with-cloud-run" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="hosting-docker-containers-with-cloud-run">Hosting Docker Containers with Cloud Run</h2>
<p>There are two main avenues for getting a docker container to Cloud Run:</p>
<ol type="1">
<li>Setting up Continous Deployment through Github</li>
<li>Uploading Docker containers manually to the Artifact Registry</li>
</ol>
<p><img src="assets/docker_upload_options.png" class="img-fluid" style="width:80.0%"></p>
<p>Here is a quick breakdown of the pros and cons of each:</p>
<div class="grid column-screen-inset-shaded">
<section id="continuous-deployment-via-github" class="level3 g-col-6">
<h3 class="anchored" data-anchor-id="continuous-deployment-via-github">Continuous Deployment via Github</h3>
<p>Pros:</p>
<ul>
<li>With each push to a designated branch, Google Cloud will automatically deploy that latest push.</li>
<li>If the latest push’s Docker container doesn’t successfully build, the last working container will continue to run.</li>
<li>Does not require working with Google Cloud’s CLI.</li>
<li>Takes less than 5 minutes to implement.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Requires strict Github protocal. Accidently pushing changes to the branch that have a fatal error on the application’s end (not a docker build error) will result in a broken application for the end user</li>
</ul>
</section>
<section id="manual-upload-to-artifact-registry" class="level3 g-col-6">
<h3 class="anchored" data-anchor-id="manual-upload-to-artifact-registry">Manual upload to Artifact Registry</h3>
<p>Pros:</p>
<ul>
<li>Seperates Github branch from the production-level product</li>
</ul>
<p>Cons:</p>
<ul>
<li>Each update to the product requires manual redeployment. (Obviously)</li>
<li>Requires setting up Google Cloud CLI on a computer, linking it to your GCP.</li>
</ul>
</section>
</div>
<section id="continuous-deployment-via-github-1" class="level3">
<h3 class="anchored" data-anchor-id="continuous-deployment-via-github-1">Continuous Deployment via Github</h3>
<div class="grid">
<div class="g-col-6">
<p>Navigate to Cloud Run in the Google Cloud Console</p>
<p><img src="assets/nav_cloud_run.png" class="img-fluid"></p>
</div>
<div class="g-col-4">
<p>and select “Connect Repo”.</p>
<p><img src="assets/nav_connect_repo.png" class="img-fluid"></p>
</div>
</div>
<p>Give the service a name, and select a region.</p>
<p>The only imperative settings here are <strong>Authentication</strong> and <strong>Ingress Control</strong>. If you want you application available to all public, select <em>Allow unauthenticated users</em> and <em>All</em> for Ingress Control. Otherwise, to setup OAuth with Identity-Aware Proxy, we will select <em>Require authentication</em> and <em>Internal</em> the checkbox <em>Allow traffic from external Application Load Balancers</em>. You may consider changing other default settings to meet your needs.</p>
<p><img src="assets/cloud_run_security.png" class="img-fluid"></p>
<p>For streamlit apps, we also want to enable <strong>Session Affinity</strong>. This will fix a host of problems that would otherwise arise.</p>
<p><img src="assets/run_session_affinity.png" class="img-fluid"></p>
<p>Hit Deploy!</p>
<p>If you aren’t adding OAuth, then you are done! Google will give you a url to access your Cloud Run service. If you own a domain and want to use a custom link, click on your Cloud run service, and look into the <em>Integrations</em> tab. There is an integration for Custom Domains.</p>
<p>To add OAuth, move onto <strong>OAuth with Identiy-Aware Proxy</strong>.</p>
</section>
<section id="manual-upload-to-artifact-registry-1" class="level3">
<h3 class="anchored" data-anchor-id="manual-upload-to-artifact-registry-1">Manual upload to Artifact Registry</h3>
<section id="setting-up-google-cloud-cli" class="level4">
<h4 class="anchored" data-anchor-id="setting-up-google-cloud-cli">Setting up Google Cloud CLI</h4>
<p>Begin by installing <a href="https://cloud.google.com/sdk/docs/install#windows">Google Cloud CLI</a></p>
<p>You may need to restart your terminal for <code>gcloud</code> to be added to your PATH.</p>
<p>Then, run <code>gcloud init</code> to configure google cloud CLI, and connect it to your google cloud account.</p>
<p>Switch your to your active Google Cloud Project: <code>gcloud config set project PROJECT_ID</code></p>
</section>
<section id="uploading-the-docker-image-to-artifact-registry" class="level4">
<h4 class="anchored" data-anchor-id="uploading-the-docker-image-to-artifact-registry">Uploading the Docker image to Artifact Registry</h4>
<section id="create-a-artifact-registry-repository" class="level5">
<h5 class="anchored" data-anchor-id="create-a-artifact-registry-repository">Create a Artifact Registry Repository</h5>
<p>Open your Google Cloud Console, and navigate to the Artifact Registry. There, create a repository to store docker images. This can also be done via command line with the followoing code:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> artifacts repositories create ARTIFACT_REPO_NAME <span class="at">--repository-format</span><span class="op">=</span>docker <span class="at">--location</span><span class="op">=</span>REGION <span class="at">--description</span><span class="op">=</span><span class="st">"DESCRIPTION"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Arguments:</p>
<ul>
<li><code>ARTIFACT_REPO_NAME</code> and <code>DESCRIPTION</code> can be whatever you want them to be.</li>
<li><code>REGION</code>: Reference <a href="https://cloud.google.com/run/docs/locations?authuser=1">Google Cloud Documentation</a> to decide which region would be best for your application. Generally, pick the region closest to you.</li>
</ul>
<p>We will also want to give our account the necessary permissions to upload Docker images to the Artifact Registry. Navigate to the IAM section of “IAM &amp; Admin”. Find your google account, and add the role “Artifact Registry Writer” to your account by clicking the small pencil on the far right of your account row.</p>
</section>
<section id="uploading-the-docker-image" class="level5">
<h5 class="anchored" data-anchor-id="uploading-the-docker-image">Uploading the Docker Image</h5>
<p>Now open a terminal and navigate to the root folder of your Dockerfile.</p>
<p>Run the following command to upload your Docker image:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> builds submit <span class="at">--region</span><span class="op">=</span>REGION <span class="at">--tag</span> REGION-docker.pkg.dev/PROJECT_ID/ARTIFACT_REPO_NAME/NAME_OF_IMAGE:TAG</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Arguments:</p>
<ul>
<li><code>REGION</code>: Region as selected earlier</li>
<li><code>PROJECT_ID</code>:
<ul>
<li>Look in Project Settings or…</li>
<li>Programmatically: gcloud config get-value project</li>
</ul></li>
<li><code>ARTIFACT_REPO_NAME</code>:
<ul>
<li>The name of the repo you made earlier</li>
</ul></li>
<li><code>NAME_OF_IMAGE</code>:
<ul>
<li>Name of your choice</li>
</ul></li>
<li><code>TAG</code>
<ul>
<li>Not neccessary</li>
<li>Tag of your choice, normally used for version history (i.e.&nbsp;1.12.2) or to describe the particular update</li>
</ul></li>
</ul>
</section>
<section id="running-docker-image-with-cloud-run" class="level5">
<h5 class="anchored" data-anchor-id="running-docker-image-with-cloud-run">Running Docker image with Cloud Run</h5>
<p>Now, navigate to Cloud Run and follow the same steps as shown in the continous deployment method, except this time we will select our image from the Artifact Registry with the “Deploy one revision from an existing container image” option.</p>
<p>Just like in the other option, Google Cloud will create a link you can use to access your Cloud Run Service. (See Continuous Deployment section for notes on custom domains)</p>
</section>
</section>
</section>
</section>
<section id="oauth-with-identity-aware-proxy" class="level2">
<h2 class="anchored" data-anchor-id="oauth-with-identity-aware-proxy">OAuth with Identity-Aware Proxy</h2>
<p>Christo Olivier gave a phenominal tutorial on the following process in <a href="https://www.youtube.com/watch?v=aJKkla4U47U">his youtube video</a>. Much of this guide follows his steps, with some additional solutions to issues I ran into following his tutorial.</p>
<section id="enable-iap-api" class="level3">
<h3 class="anchored" data-anchor-id="enable-iap-api">Enable IAP API</h3>
<p>First, lets enable the Identity-Aware Proxy API and configure the OAuth consent screen.</p>
<p><img src="assets/nav_iap.png" class="img-fluid"> <img src="assets/config_cons_sc.png" class="img-fluid"></p>
<p>With our goal to only allow those with the same google org email domain to access our Cloud Run Service, we will select “Internal”:</p>
<p><img src="assets/cons_sc_int.png" class="img-fluid"></p>
<p>Fill out the required feilds:</p>
<ul>
<li>App Name</li>
<li>User supported email</li>
<li>Developer email address</li>
</ul>
<p>You may also consider uploading an app logo to improve the look of your OAuth consent screen.</p>
<p>We will not need any user scopes, as our application does not need any information about the particular user in our organization, so hit “Save and Continue”.</p>
</section>
<section id="create-a-load-balancer" class="level3">
<h3 class="anchored" data-anchor-id="create-a-load-balancer">Create a Load Balancer</h3>
<p>For a Cloud Run service to have an Identity-Aware Proxy OAuth layer, it must be fed through a Load Balancer.</p>
<p>Navigate to “Load Balancing” under the “Network Services” Category</p>
<p><img src="assets/nav_load_bal.png" class="img-fluid"></p>
<p>Create a new load balancer, and configure with the following choices: - Application Load Balancer (HTTP/HTTPS) - Public facing (external) - Best for global workloads - Global external Application Load Balancer</p>
<p>Frontend:</p>
<ul>
<li>Name doesn’t matter: streamlit-fe (fe for front end)</li>
<li>Protocal: HTTPS</li>
<li>IP address: Create IP Adress
<ul>
<li>Name doesn’t matter: streamlit-ip</li>
</ul></li>
<li>Certificate: Create a New Certificate
<ul>
<li>Create mode: Create Google-managed certificate</li>
<li>Give it a domain you plan to host the streamlit app on.
<ul>
<li>EX: reports.sales.name-of-domain.com</li>
</ul></li>
</ul></li>
<li>Enable HTTP to HTTPS redirect</li>
</ul>
<p>Backend:</p>
<ul>
<li>Create a Backend Service.</li>
<li>Name doesn’t matter: streamlit-be</li>
<li>Backend Type: Serverless network endpoint group</li>
<li>Serverless network endpoint groups: Create Serverless Network Endpoint Group
<ul>
<li>Name doesn’t matter: streamlit-neg</li>
<li>Region: Choose the same region your Cloud Run service is hosted in</li>
<li>Select that service</li>
</ul></li>
</ul>
<p>Routing Rules:</p>
<pre><code>- Keep on "Simple host and path" rule</code></pre>
<p>Click Create</p>
<p>Once the load balancer has been created, click on it, and view the frontend IP address.</p>
<p><img src="assets/load_frontend_ip.png" class="img-fluid"></p>
<p>You will need to swiftly enter this ip address into the domain with the corresponding domain or subdomain. For example, managing a domain via squarespace would look something like this:</p>
<p><img src="assets/squarespace_domain.png" class="img-fluid"></p>
<p>We choose Type “A” because our Data entry is an IP address. The Host section is reports.sales, because I have chosen to host this app on reports.sales.name-of-your-domain.com, which matches the domain entered into the certificate of the load balancer.</p>
<p>Once this step is complete, view the certificate of the load balancer. It may take 5 minutes to an hour, but so long as the domain information was entered correctly on both the certificate’s end and the domain’s end, it should eventually pivot from “PROVISIONING” to “ACTIVE”.</p>
<p><img src="assets/load_cert.png" class="img-fluid"></p>
</section>
<section id="enable-iap-for-load-balancer" class="level3">
<h3 class="anchored" data-anchor-id="enable-iap-for-load-balancer">Enable IAP for Load Balancer</h3>
<p>Return to the Identity-Aware Proxy section. You should see the backend of our load balancer we created on the IAP screen. Enable it for IAP, and ADD PRINCIPAL to organization-name.com to have the IAP-secured Web App User role.</p>
<p>Enabling IAP should have created an IAP service bot that we need to give access to invoke our Cloud Run service. Return to IAM &amp; Admin, and give <code>service-PROJECT_NUMBER@gcp-sa-iap.iam.gserviceaccount.com</code> the role “Cloud Run Invoker”.</p>
<p>While this service bot should be automatically created, (for me) it often isn’t. However, this service bot can be created manually via Google Cloud CLI beta commands:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> beta services identity create <span class="at">--project</span><span class="op">=</span>PROJECT_ID <span class="at">--service</span><span class="op">=</span>iap.googleapis.com</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The created service account may not appear in the list service accounts in IAM, but that is okay; replace <code>PROJECT_NUMBER</code> with your project number, paste the account into Principal section of “Grant Access”, and give it the role “Cloud Run Invoker”.</p>
<section id="the-waiting-game" class="level4">
<h4 class="anchored" data-anchor-id="the-waiting-game">The Waiting Game</h4>
<p>Google says it can take up to 24 hours for this to fully work. In my trials of this process, it only took about 10-20 minutes until the website was able to link up nicely. If you get “<em>Error: Page not found. The requested URL was not found on this server.</em>” or “<em>reports.sales.name-of-domain.com did not send any data</em>”, then you did something wrong.</p>
<p>The error you hope to see has to do with google not being able to recongize the method of data flow (something along these lines). For me, this meant I just needed to be patient, and 10ish minutes later, streamlit loaded.</p>
<p>If you get “Error: Forbidden”, then something is wrong with your IAP setup. Ensure your domain has the “IAP-secured Web App” role, your iap service bot has the role “Cloud Run Invoker”, and your Ingress control allows traffic from Application Load Balancers</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>